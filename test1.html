<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SoW Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.7/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.46.0/docxtemplater.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/file-saver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #003366; }
    .form-section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    button { margin-top: 15px; padding: 10px 20px; border: none; border-radius: 4px; background: #003366; color: white; cursor: pointer; }
    button:hover { background: #0055aa; }
  </style>
</head>
<body>
  <h2>SoW Generator (Cyber Assessment)</h2>

  <!-- General Info -->
  <div class="form-section">
    <h3>General Information</h3>
    <label>Assessment Type <input id="assessmentType"></label>
    <label>NAV ID <input id="navId"></label>
    <label>BSA Ref <input id="bsaRef"></label>
    <label>Service Name <input id="serviceName"></label>
    <label>Start Date <input id="startDate" type="date"></label>
    <label>End Date <input id="endDate" type="date"></label>
    <label>Lead Name <input id="leadName"></label>
    <label>Lead Email <input id="leadEmail"></label>
    <label>Project Name <input id="projectName"></label>
    <label>Project Email <input id="projEmail"></label>
    <label>LSC Name <input id="lscName"></label>
    <label>LSC Email <input id="lscEmail"></label>
    <label>ASC Name <input id="ascName"></label>
    <label>App ID <input id="appId"></label>
    <label>Tech ID <input id="techId"></label>
    <label>Budget Holder <input id="budgetHolder"></label>
    <label>Project/Service Manager <input id="manager"></label>
  </div>

  <!-- Dynamic Table -->
  <div class="form-section">
    <h3>Assessment Schedule</h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Activity</th>
          <th>Proposed Start</th>
          <th>Proposed End</th>
          <th>Effort (Days)</th>
          <th>Daily Cost</th>
          <th>Cost</th>
          <th>Location</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="button" onclick="addRow()">+ Add Row</button>
  </div>

  <button onclick="generateDoc()">Generate Word</button>

  <script>
    // Add rows dynamically
    function addRow() {
      const tbody = document.querySelector("#scheduleTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input class="activity"></td>
        <td><input class="proposedStart" type="date"></td>
        <td><input class="proposedEnd" type="date"></td>
        <td><input class="effort" type="number"></td>
        <td><input class="dailyCost" type="number"></td>
        <td><input class="cost" type="number"></td>
        <td><input class="location"></td>
        <td><button type="button" onclick="this.parentElement.parentElement.remove()">X</button></td>
      `;
      tbody.appendChild(row);
    }

    async function generateDoc() {
      const data = {
        assessmentType: document.getElementById("assessmentType").value,
        nav_id: document.getElementById("navId").value,
        bsa_ref: document.getElementById("bsaRef").value,
        service_name: document.getElementById("serviceName").value,
        startDate: document.getElementById("startDate").value,
        endDate: document.getElementById("endDate").value,
        lead_name: document.getElementById("leadName").value,
        lead_email: document.getElementById("leadEmail").value,
        projectName: document.getElementById("projectName").value,
        proj_email: document.getElementById("projEmail").value,
        lsc_name: document.getElementById("lscName").value,
        lsc_email: document.getElementById("lscEmail").value,
        asc_name: document.getElementById("ascName").value,
        app_id: document.getElementById("appId").value,
        tech_id: document.getElementById("techId").value,
        budget_holder: document.getElementById("budgetHolder").value,
        manager: document.getElementById("manager").value,
        rows: []
      };

      // Collect dynamic rows
      document.querySelectorAll("#scheduleTable tbody tr").forEach(tr => {
        data.rows.push({
          activity: tr.querySelector(".activity").value,
          proposedStart: tr.querySelector(".proposedStart").value,
          proposedEnd: tr.querySelector(".proposedEnd").value,
          effort: tr.querySelector(".effort").value,
          dailyCost: tr.querySelector(".dailyCost").value,
          cost: tr.querySelector(".cost").value,
          location: tr.querySelector(".location").value
        });
      });

      // Calculate totals
      data.totalEffort = data.rows.reduce((sum, r) => sum + Number(r.effort || 0), 0);
      data.totalCost = data.rows.reduce((sum, r) => sum + Number(r.cost || 0), 0);

      // Load Word template
      const response = await fetch("SoW_Template.docx");
      const content = await response.arrayBuffer();

      const zip = new PizZip(content);
      const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
      doc.render(data);

      const out = doc.getZip().generate({
        type: "blob",
        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      });
      saveAs(out, "SoW_Generated.docx");
    }
  </script>
</body>
</html>
